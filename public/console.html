<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://cdn.bootcss.com/semantic-ui/2.3.1/semantic.min.css" rel="stylesheet">
  <title>Console - Logmonster</title>
  <style>
    html {
      font-family: "Menlo", "DejaVu Sans Mono", "Liberation Mono", "Consolas", "Ubuntu Mono", "Courier New", "andale mono", "lucida console", monospace;
    }

    body > div {
      min-height: 100%;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    pre code {
      font-size: 12px;
    }

    pre code p {
      margin: 0;
    }
  </style>
</head>
<body>
<div class="ui inverted attached code segment">
  <pre><code id="console"></code></pre>
</div>
<script src="/js/console.js"></script>
<script>
  const target = /\/targets\/([a-zA-Z0-9-]+)\/console/.exec(location.pathname)[1];

  const logConsole = new LogConsole('#console');

  // EventSource
  const sse = new EventSource(`/api/targets/${target}/console${location.search}`);
  sse.addEventListener('log', function (e) {
    let isAttached = isAttachedBottom();
    logConsole.append(e.data);
    isAttached && attachBottom();
  });
  sse.addEventListener('error', function (e) {
    if (e.data) {
      logConsole.appendError(e.data);
    }
    sse.close();
  });

  let initialized = false;

  function isAttachedBottom() {
    let clientHeight = document.documentElement.clientHeight;
    let scrollHeight = document.documentElement.scrollHeight;
    let scrollTop = document.documentElement.scrollTop;
    if (scrollHeight > clientHeight) {
      if (initialized) {
        let scrollBottom = scrollHeight - scrollTop - clientHeight;
        return Math.abs(scrollBottom) <= 1.2;
      } else {
        initialized = true;
        return true;
      }
    }
    return false;
  }

  function attachBottom() {
    window.scrollTo(0, document.documentElement.scrollHeight);
  }

</script>
</body>
</html>
